Weakly Supervised Scene Parsing with Point-based Distance Metric Learning

Abstract
Semantic scene parsing is suffering from the fact that pixellevel annotations are hard to be collected. To tackle this issue, we propose a Point-based Distance Metric Learning (PDML) in this paper. PDML does not require dense annotated masks and only leverages several labeled points that are much easier to obtain to guide the training process. Concretely, we leverage semantic relationship among the annotated points by encouraging the feature representations of the intra-and intercategory points to keep consistent, i.e. points within the same category should have more similar feature representations compared to those from different categories. We formulate such a characteristic into a simple distance metric loss, which collaborates with the point-wise cross-entropy loss to optimize the deep neural networks. Furthermore, to fully exploit the limited annotations, distance metric learning is conducted across different training images instead of simply adopting an image-dependent manner. We conduct extensive experiments on two challenging scene parsing benchmarks of PASCAL-Context and ADE 20K to validate the effectiveness of our PDML, and competitive mIoU scores are achieved.

Introduction
Scene parsing is of critical importance in mid-and highlevel vision. Various machine vision applications lie on the basis of detailed and accurate scene analysis and segmentation i.e. outdoor driving system  #b5 ), image retrieval  #b19 ) and editing  #b18 . To achieve the goal of successfully recognizing objects in common scenes, datasets with careful and comprehensive labeling such as the PASCAL-Context  #b13  and ADE 20K  #b27  are putting forward to the community at great expense. Compared with image semantic segmentation where many semantic regions are coarsely divided into a unified background class, pixel-wise annotations for scene parsing datasets require much more efforts as more fine-grained regions (e.g. wall and ground) need to be specified manually. Though current state-of-the-art methods such as PSPNet  and Deeplab  #b3  have already obtained impressive performance on these datasets, the limitations of relying on densely-annotated data would be magnified as dozens of new circumstances i.e. autonomous driving in the wild, drone navigation coming into horizon. It is both time consuming and expensive to carefully annotate a brand new dataset for each specific application.Attempts have been made to alleviate the annotation burden by introducing multiple weakly supervised formats i.e. image-level supervision  #b16 , box supervision  #b4  and scribble supervision . In the mean time, as suggested in  #b2 , to annotate a single pixel for each instance is a natural scheme for human reference and the cost could be greatly alleviated. Furthermore, Bearman's work tackles the easier semantic segmentation and focuses more on analyzing the effectiveness of the point-based scheme itself by analyzing the annotation quality and taking the interaction with annotators as an important factor in the loss function. We believe that the potential of point-based supervision has not been well explored and also, the more challenging task of point-based scene parsing has remained untouched.Thus, this paper serves as an initial attempt to explore the possibility of point-guided weakly supervised scene parsing. Being given only one semantic annotated point per instance, we propose a novel point-based distance metric learning method (PDML) to tackle this challenging task. PDML leverages semantic relationship among the annotated points by encouraging the feature representations of the intra-and inter-category points to keep consistent. Points within the same category are optimized to share more similar feature representations and oppositely, features of points from different categories are optimized to be more distinct. We implement this optimizing procedure by utilizing a distance metric loss, which collaborates with the point-wise cross-entropy loss to optimize the whole deep neural network. More important, different from current weakly supervised methods whose solutions are constrained in a single image, we conduct distance metric learning across different training images, so that the limited human annotated points can be fully exploited. Extensive experiments are performed on two challenging scene parsing benchmarks: PASCAL-Context and ADE 20K. We achieve the mIoU score of 30.0% on PASCAL-Context, which is impressive compared to the result of 39.6% from fully supervised scheme by using only 7.2 × 10 −5 the number of annotated pixels. And we achieve mIoU of 19.6% on ADE 20K, while the SegNet (Badrinarayanan, Kendall, and Cipolla 2017) produces roughly 21% under full annotation of this dataset.In conclusion, the major contributions of this paper lie in the following aspects:• We are the first to deal with the task of point-based weakly supervised scene parsing. • We propose a novel deep metric learning method PDML which optimizes the intra-and inter-category embedding feature consistency among the annotated points. • PDML is performed across different training images to fully exploit the limited annotations, which is very novel compared to traditional intra-image methods. • Our method has competitive performance both qualitatively and quantitatively on PASCAL-Context and ADE 20K scene parsing dataset.

Related Work
Weakly Supervised Semantic Segmentation Image-level Annotations Image-level annotations by just naming the objects and staff are easy and natural to obtain.  #b16 ) explore multiple instance learning for semantic segmentation.  #b15  propose dynamic prediction of foreground and background by using Expectation-Maximization algorithm. (Kolesnikov and Lampert 2016) introduce the new loss function of seed, expand and constrain.  #b22 ) utilize a simple to complex framework to further improve the performance. And object region mining and localization is experimented in ,  #b21 ,  #b25  and  #b8 . And ) discuss the effect of dilated convolution in this task. However, the methods listed below all focus on object-based semantic segmentation while no attempts have been made to deal with the more difficult scene parsing. Recently  #b24  tackle image-description guided scene parsing but investigating on parsing a scene image into a structured configuration.Region-specified Annotations Compared to image-level annotations where no explicit location related information are given, multiple attempts have been made to provide various region-specified semantic supervision. Annotated bounding boxes are utilized in  #b4  and  #b15 . ) use scribbles as the supervision information and graphic models are used in optimization. Furthermore,  #b2  have a similar setup with us but target at semantic segmentation. Also, they focus more on analyzing point supervision regime itself by comparing the annotation time, error rate as well as quality with other supervision regimes. Their method takes the confidence of annotators as a parameter in the loss function and transfers image-level annotations to objectness priors by utilizing another model pretrained on non-overlapping datasets. In comparison, we put attention on the more difficult task of scene parsing. We do not use any additional data and focus on exploring the cross-image semantic relations to boost the scene parsing performance.

Deep Metric Learning
Deep metric learning on embedding features has been explored in various tasks such as image query-andretrieval (Oh  #b14 , face recognition  #b17  and verification  #b12 ). It has also been applied in semantic instance segmentation  #b6 ) and grouping  #b9 . More recently,  #b11 ) use metric learning as a fast and efficient way for training a semantic segmentation network.

Proposed Method Motivation
Compared to full, box and scribble supervision regime, point-based supervision data is most natural for human reference and easiest to obtain. However, as illustrated in Table  1, the annotation number of pixels in single image is too tiny to train a neural network efficiently.

Annotation Method Full ScribbleSup PointSup
Anno. pixel/image 170k 1817.48 12.26 Consider the limitation of supervision information and inspired by recent deep metric learning methods e.g.  #b11 ), we focus on exploring the relationship between feature representations of annotated pixels. While all current methods try to optimize embedding feature distances within a single image, we apply a novel method by forming triples from the embedding vectors of annotated pixels across images and optimizing the feature consistency within the triples by distance metric learning. In each triple, two embedding vectors belong to the same category and we name them as a positive pair. The other is from a different category and it forms a negative pair with one element in the positive pair. We minimize the distances between positive pairs and maximize those between negative pairs on interimage level. There are at least two reasons for doing so: • Objects and stuff which have similar feature representations before the classification module would be more likely to be specified into the same class. Oppositely, embedding features from different categories, if being distinct enough with each other, are more easier for the classifier to distinguish. • Under the point-based regime, most annotated pixels in one image come from different categories. Simply optimizing distances between negative pairs would not help training. While extending to inter-image level, balanced number of positive and negative pairs can be obtained. Furthermore, different from image-level weakly supervised methods relying heavily on the saliency maps generated by pretrained specific models, scribble and box guided methods depending on being optimized iteratively, our method does not require any additional data and can be learned in an end-to-end manner. Overview Figure 1 shows the pipeline of our algorithm. Similar to Deeplab  #b3 ), we utilize ResNet101 ) pretrained on ImageNet as the backbone of our feature extractor. Atrous convolutions are adopted to increase the receptive field and reduce the degree of signal downsampling. Given a batch of input images, we first use the feature extractor to form deep embedding features. The features are then assigned to two streams. The first stream is feeding into the point-based distance metric learning module where the embedding feature vectors across different images are optimized towards learning representation consistency. The second stream is feeding into a fully-convolutional classification module to generate the pixel-wise prediction. At the mean time, online extension is performed to dynamically gather pixels with high classification confidence and tight spatial relationship to the original annotated pixels to form the extended label. The point-wise cross-entropy loss is calculated between the classification results and the two labels.

Point Supervision
Point supervision (PointSup) serves as the baseline of our method. Let S p donate the set of training images with pointwise annotations. Then we have S p = N w=1 {(I w , M w )} where I w is the wth image in the training set. M w is the corresponding pseudo annotated mask, where only several pixels are annotated with semantic labels. Let g(f (I w ; θ f ); θ g ) donate our segmentation module where (f, θ f ), (g, θ g ) refer to the feature extraction module and its parameters, classification module and its parameters, respectively. The objective function ismin θ f ,θg N w=1 J w (g(f (I w ; θ f ); θ g )),(1)and then consider the class label set of the current image as C, let the the conditional probability generated by the classification module of any label c ∈ C at the any location u as g u,c (f (I w ; θ f ); θ g ), then we getJ w (g(f (I w ; θ f ); θ g )) = − c∈C u∈M c w log g u,c (f (I w ; θ f ); θ g ) c∈C |M c w | ,(2)where | * | refers to number of annotated pixels in * .

Distance Metric Learning
To optimize feature representations of annotated pixels to keep consist, we aim at minimizing distances between positive pairs and maximizing those between negative pairs. However, it is hard to find positive pairs within a single image. Only optimizing negative pairs would do no help but make the loss hard to converge. By extending to inter-image level, we could obtain balanced number of two kinds of pairs as illustrated in Figure 2. E a = |Ma| i=1 {P ai },where P ai is the feature vector corresponding to the ith annotated pixel in image a. Suppose for three different feature vectors P ai , P bj , P bk , where P ai shares the same category with P bj and different from P bk , we apply the loss L t as L t (P ai , P bj , P bk ) =αL p (P ai , P bj ) + βL n (P ai , P bj , P bk ),where L p (P ai , P bj ), corresponding to the red dotted line in Figure 2(b) (i.e. (P a1 , P b1 )), can be expressed asP ai − P bj 2 ,(4)which aims at minizing the L2-norm distance between samecategory embedding vectors. And L n (P ai , P bj , P bk ), corresponding to the combination of one gray and one red dotted line in Figure 2(b) (i.e. (P a1 , P b1 ) and (P a1 , P b2 )), can be expressed asmax( P ai − P bj 2 − P ai − P bk 2 + m, 0),(5)which aims at maximizing the gap between P ai − P bj 2 and P ai − P bk 2 . m is a constant value and only when the gap is within this value would the the triple embedding vectors be optimized. Two hyper-parameters α and β are used to balance the the effect of L p and L n . We set m = 20, α = 0.8, β = 1 in practice. And the algorithm of optimizing dense PDML is expressed in Algorithm 1.

Online Extension
To further improve the performance, we put attention on gathering more pixels during the training process. Previous S P = S P − s 25 end works such as superpixel  #b0 ) and K-Means clustering (Ray and Turi 1999) have explored the possibility of gathering pixels by measuring the similarity of lowlevel features. However, both methods have obvious drawbacks under the point-based scene parsing regime by gathering lots of wrong pixels. And from experiments we find that wrong pixels would greatly degrade the performance of the network. More detailed analyses would be found in the section of discussion. To tackle this issue, we adopt a simple but accurate online extension method to collect more pixels with low false positive rate to extend the annotation data. Take (I a , M a ) ∈ S p as an example, we now assume the current weights of feature extractor f and classification module g as θ f 1 and θ g1 , then we could specify the new label candidate M a score by judging the pixel-wise classification score: (6) where thr is a threshold to filter the pixels. In other words, for every location u in the input image, if the max classification score of this pixel is greater than the threshold and the corresponding class is within the class label set of this image, it would be chosen for the extended label. From another perspective, we believe that pixels with close spatial distance to the annotated pixels are more likely from the same category. Thus we extend each annotated pixel in M a to a 5 × 5 square to form the second label candidate M a region . Then we generate the final extended label M a extend by just selecting the candidates appearing in both schemes as:M a score = u {max(g u,c∈C (f (I a ; θ f 1 ); θ g1 )) > thr},M a extend = M a score ∩ M a region .(7)Experimental Results

Implementation Details
Dataset and Evaluation Metrics Our proposed model is trained and evaluated on two challenging scene parsing datasets: PASCAL-Context  #b13 ) and ADE 20K  #b27 , as shown in Table 2. In PASCAL-Context, the most frequent 59 classes are used and others are divided into a unified background class. In ADE 20K, we adopt the annotation of 150 meaningful classes. We generate one pixel annotation for each instance in each image. The performances are quantitatively evaluated by pixel-wise accuracy and mean region intersection over union (mIoU).  Training Setting We utilize ResNet101  with the modification of atrous convolution as the backbone of our feature extractor. Weights pretrained on ImageNet are adopted to initialize. During training, we take a minibatch of 16 images and randomly crop patches of the size of 321 × 321 from original images. We use the optimizer of SGD where momentum is set to 0.9 and the weight decay is 0.0005. The initial base learning rate is set to 0.00025 for parameters in the feature extraction layers and ten times for parameters in the classification module. Both learning rate will be decayed under the scheme of base lr * (1− epoch max epoch ) 0.8 . All the experiments are conducted on two NVIDIA V100 GPUs. Our code will be available publicly.

Quantitative and Qualitative Results
We evaluate different methods quantitatively by using pixel accuracy and mIoU which describes the the precision of prediction and the average performance among all classes, respectively. We run multiple experiments to determine the effects of the three parts of our proposed method: PointSup, PDML and online extension. To make a more comprehensive understanding of the effect of our method, we also train our network with fully-annotated label. The quantitative results are shown in Tables 3 and 6 (note we omit % of mIoU for simplicity). On PASCAL-Context, the full supervision setting could yield a 39.6% mIoU and our method, with only 7.2 × 10 −5 the number of annotated pixels, could obtain the 30.0% mIoU performance. On ADE 20K, we achieve the mIoU of 19.6%, while the SegNet  #b1  achieves roughly 21% mIoU under full supervision. And the qualitative results are shown in Figures 5 and 6. Our final method combining point supervision, distance metric learning and online extension has the best scene parsing quality subjectively.  

Discussion


Analysis of PDML
Loss function Recall that we apply the loss L t = αL p + βL n to optimize the consistency of embedding vectors. We name the distance between the positive pairs as dis(+) and that between negative pair as dis(−). L p aims at constraining dis(+) and L n aims at increasing the gap between dis(+) and dis(−). We argue that L p is very import in the whole scheme, as shown in Figure 3. With only applying L n , though the gap between dis(+) and dis(−) is optimized to be larger, the absolute values increase greatly at the mean time which leads to great performance drop. And by applying the constrain of L p , the absolute values of distances remain at the normal scale and the gap is also optimized to make it easier for the classification module to distinguish. Also, we visualize the distribution of the pair numbers of each distance value in training procedure to demonstrate the effectiveness of L t . At the first epoch, the distributions of distances of positive and negative pairs are almost symmetrical. During the training process, an obvious peak shift can be observed. The peak of the distances between positive pairs moves towards the origin of the coordinate axis and peak of the distances between negative pairs moves oppositely. Hyper-parameters We have three hyper-parameters in the loss function: m, α, β. Margin m is set for a mining purpose. A small margin would limit the number of optimizing embedding vector triples and make it less effective for classification. And a large margin size, bringing too many triples for optimization, would cause the training loss being hard to converge. A moderate margin value of 20 would produce the best performance. Loss weights α and β are used to balance the effect of L p and L n . We set β to 1 and adjust α correspondingly. A small α, similar to Figure 3, can not constrain the absolute value of dis(+) and dis(−) to remain at the normal scale and would lead to poor performances. While a large α would weaken the effect of maximizing the distance between dis(+) and dis(−) and make it hard to distinguish embedding vectors from different categories. A moderate value of 0.8 achieves the best performance.  

Analysis of Extension Method
We compare our online label extension method with other frequently used clustering method. Superpixel Superpixel is used to cluster pixels by taking low-level feature similarity into consideration. We set the number of superpixels in the range of 50 to 200 per image depending on the number of annotated pixels. Each annotated pixel would be extended to the corresponding superpixel covering it. K-Means We perform K-Means clustering on the feature representations of the input images. The annotated pixels are set to be the initial clustering centers and we set the maximum iteration time to be 300. Score and Region Recall in the online extension part, we use two methods to generate new label candidates. The first is using a score thresholding and we name this extension method as score. And another is simply extending every pixel in the current label to a 5 × 5 square with the original one as the center. We name this method as region.On the basis of the weight obtained by PDML, we implement different extension methods and their results are shown in Table 5. The pixel-wise extension accuracy is of critical importance in influencing the performance. Superpixel and region have better extension accuracies and have better performances correspondingly. We also test various thresholds for the score scheme. Our method taking both score with the threshold of 0.7 and region into consideration has an accuracy of 98.2% and the best testing performance.  

Conclusion
This paper is the first to tackle the task of point-based semantic scene parsing. We propose a novel deep metric learning method to leverage semantic relationship among the annotated points by encouraging the feature representation of the intra-and inter-category points to keep consistent. Points within the same category are optimized to share more similar feature representations and oppositely, those of points from different categories are optimized to be more distinct. Different from all current weakly supervised methods whose solutions are constrained in a single image, our proposed method focuses on optimizing the embedding vectors across different images in the training dataset to obtain sufficient balanced embedding vector pairs. The whole model can be trained in an end-to-end manner. Our method has competitive performance both qualitatively and quantitatively on PASCAL-Context and ADE 20K scene parsing datasets.